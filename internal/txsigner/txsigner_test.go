// nolint
package txsigner

import (
	"encoding/hex"
	"encoding/json"
	"testing"

	"github.com/btcsuite/btcd/chaincfg"
	"github.com/dig-coins/btcconnect/internal/share"
	"github.com/dig-coins/btcconnect/internal/utl"
	hdwallet "github.com/dig-coins/hd-wallet"
	"github.com/stretchr/testify/assert"
)

var _uTConfig *utl.UTConfig

func TestMain(m *testing.M) {
	_uTConfig = utl.Setup()

	m.Run()
}

func utNewTxSinger(t *testing.T) *TxSigner {
	return utNewTxSingerEx(t, "../../datas/eseeds.dat")
}

func utNewTxSinger1(t *testing.T) *TxSigner {
	return utNewTxSingerEx(t, "../../datas/eseed-1.dat")
}

func utNewTxSinger2(t *testing.T) *TxSigner {
	return utNewTxSingerEx(t, "../../datas/eseed-2.dat")
}

func utNewTxSingerEx(t *testing.T, seedFileName string) *TxSigner {
	signer, err := NewTxSigner(hdwallet.BTCTestnet, &chaincfg.TestNet3Params, seedFileName,
		_uTConfig.GetSSeedsFileSecKey(t), map[string]*share.MultiSignAddressInfo{
			"2N59MZ6kPV1qWvahhUzDzZGXo4ZsjAmF14i": {
				PublicKeys: []string{
					"02f410e07213396b8d6289ca6f1c217380a2787db5a7487b0978bd792cbd32343e",
					"028e7bbb364b64687db98ad39674e70c194aa01ef3da3148791536f25ab8861c02",
					"037cb184baf184ec6d3f24c927c6243dbb122ae7f9353425f84f3dfcd95fdcd0f9",
					"037f9e1716a16efb9cf977a628942a5ee193aa29d31d99a6ddbb80d1d7dd69b5da",
				},
				MinSignNum: 3,
			},
		})
	assert.Nil(t, err)

	return signer
}

func TestTxSigner(t *testing.T) {
	signer := utNewTxSinger(t)

	wpi := "7b22696e70757473223a5b7b2254784944223a2239376561366337376365316631383438636534653433353438333338346664373331626364323766303762373663613463633332663736353862313031653536222c22564f7574223a312c2241646472657373223a226d77733455465250385845384a687765586867794d476b56505a66434d5346676d78222c22416d6f756e74223a34323435312c2252656465656d536372697074223a22227d5d2c226f757470757473223a5b7b2241646472657373223a2274623171383868303667787135636770793536363833326436717a637961657937786864646c32686574222c22416d6f756e74223a313030307d2c7b2241646472657373223a226d77733455465250385845384a687765586867794d476b56505a66434d5346676d78222c22416d6f756e74223a34313232327d5d7d"

	d, err := hex.DecodeString(wpi)
	assert.Nil(t, err)

	var m map[string]any
	err = json.Unmarshal(d, &m)
	assert.Nil(t, err)
	d, err = json.MarshalIndent(m, "", "\t")
	assert.Nil(t, err)
	t.Log(string(d))

	signedTxHex, rIsMultiSignMidTx, err := signer.SignTx(wpi)
	assert.Nil(t, err)
	assert.False(t, rIsMultiSignMidTx)

	t.Log(signedTxHex)
}

func TestTxSigner1_Create(t *testing.T) {
	signer := utNewTxSinger1(t)

	wpi := "7b22696e70757473223a5b7b2254784944223a2237356461623062376663636231323963333634393835303736363637366463323031373932366534363366363338313435333632346235386362633065623861222c22564f7574223a302c2241646472657373223a22324e35394d5a366b505631715776616868557a447a5a47586f345a736a416d46313469222c22416d6f756e74223a37303030302c2252656465656d536372697074223a223533323130326634313065303732313333393662386436323839636136663163323137333830613237383764623561373438376230393738626437393263626433323334336532313032386537626262333634623634363837646239386164333936373465373063313934616130316566336461333134383739313533366632356162383836316330323231303337636231383462616631383465633664336632346339323763363234336462623132326165376639333533343235663834663364666364393566646364306639323130333766396531373136613136656662396366393737613632383934326135656531393361613239643331643939613664646262383064316437646436396235646135346165227d2c7b2254784944223a2261393937666638656136306438396462373637666161316539636431326234663536343532336565366239333563323064363736313136336134626536663463222c22564f7574223a302c2241646472657373223a2274623171383868303667787135636770793536363833326436717a637961657937786864646c32686574222c22416d6f756e74223a313030302c2252656465656d536372697074223a22227d5d2c226f757470757473223a5b7b2241646472657373223a226d77733455465250385845384a687765586867794d476b56505a66434d5346676d78222c22416d6f756e74223a37303130307d2c7b2241646472657373223a22324e35394d5a366b505631715776616868557a447a5a47586f345a736a416d46313469222c22416d6f756e74223a3334387d5d7d"

	d, err := hex.DecodeString(wpi)
	assert.Nil(t, err)

	var m map[string]any
	err = json.Unmarshal(d, &m)
	assert.Nil(t, err)
	d, err = json.MarshalIndent(m, "", "\t")
	assert.Nil(t, err)
	t.Log(string(d))

	signedTxHex, rAllSigned, err := signer.SignTx(wpi)
	assert.Nil(t, err)

	t.Log(rAllSigned)
	t.Log(signedTxHex)
}

func TestTxSigner2_Update(t *testing.T) {
	signer := utNewTxSinger2(t)

	wpi := "7b22556e7369676e65645478486578223a2237623232363936653730373537343733323233613562376232323534373834393434323233613232333733353634363136323330363233373636363336333632333133323339363333333336333433393338333533303337333633363336333733363634363333323330333133373339333233363635333433363333363633363333333833313334333533333336333233343632333533383633363236333330363536323338363132323263323235363466373537343232336133303263323234313634363437323635373337333232336132323332346533353339346435613336366235303536333137313537373636313638363835353761343437613561343735383666333435613733366134313664343633313334363932323263323234313664366637353665373432323361333733303330333033303263323235323635363436353635366435333633373236393730373432323361323233353333333233313330333236363334333133303635333033373332333133333333333933363632333836343336333233383339363336313336363633313633333233313337333333383330363133323337333833373634363233353631333733343338333736323330333933373338363236343337333933323633363236343333333233333334333336353332333133303332333836353337363236323632333333363334363233363334333633383337363436323339333836313634333333393336333733343635333733303633333133393334363136313330333136353636333336343631333333313334333833373339333133353333333636363332333536313632333833383336333136333330333233323331333033333337363336323331333833343632363136363331333833343635363333363634333336363332333436333339333233373633333633323334333336343632363233313332333236313635333736363339333333353333333433323335363633383334363633333634363636333634333933353636363436333634333036363339333233313330333333373636333936353331333733313336363133313336363536363632333936333636333933373337363133363332333833393334333236313335363536353331333933333631363133323339363433333331363433393339363133363634363436323632333833303634333136343337363436343336333936323335363436313335333436313635323237643263376232323534373834393434323233613232363133393339333736363636333836353631333633303634333833393634363233373336333736363631363133313635333936333634333133323632333436363335333633343335333233333635363533363632333933333335363333323330363433363337333633313331333633333631333436323635333636363334363332323263323235363466373537343232336133303263323234313634363437323635373337333232336132323734363233313731333833383638333033363637373837313335363336373730373933353336333633383333333236343336373137613633373936313635373933373738363836343634366333323638363537343232326332323431366436663735366537343232336133313330333033303263323235323635363436353635366435333633373236393730373432323361323232323764356432633232366637353734373037353734373332323361356237623232343136343634373236353733373332323361323236643737373333343535343635323530333835383435333834613638373736353538363836373739346434373662353635303561363634333464353334363637366437383232326332323431366436663735366537343232336133373330333133303330376432633762323234313634363437323635373337333232336132323332346533353339346435613336366235303536333137313537373636313638363835353761343437613561343735383666333435613733366134313664343633313334363932323263323234313664366637353665373432323361333333343338376435643764222c22556e636f6d706c65746564486578223a223762323234643735366337343639353336393637366534393665373037353734343936653636366637333232336137623232333032323361376232323530373536323663363936333462363537393733323233613562323233303333333736363339363533313337333133363631333133363635363636323339363336363339333733373631333633323338333933343332363133353635363533313339333336313631333233393634333333313634333933393631333636343634363236323338333036343331363433373634363433363339363233353634363132323564326332323464363936653533363936373665346537353664323233613333326332323533363936373665363536343465373536643232336133323764376432633232353336393637366534393665373037353734343636633631363732323361376232323331323233613636363136633733363537643764222c225478486578223a223031303030303030303238616562633063623538346236323533313433386636363365343236373930316332366436373636303738353439333639633132636266636237623064613735303030303030303066643230303130303438333034353032323130306137313831613062666163633236643832383535356335333734656633663536316565303238323633663861353835343363646161323938343131363731313030323230376639613862666234646331326234386634343534663566343134643834333065306130616136653937646664396366633533386564333838666637313937393031343833303435303232313030613833346131613537613538363465343931373065623030613030396163363435663364653532346437643631306466313334313263303238306337646463343032323035393235353237376462626337353433376231613465393265366665343266313863633866383939653465306262633631633330323636363038633166633236303134633862353332313032663431306530373231333339366238643632383963613666316332313733383061323738376462356137343837623039373862643739326362643332333433653231303238653762626233363462363436383764623938616433393637346537306331393461613031656633646133313438373931353336663235616238383631633032323130333763623138346261663138346563366433663234633932376336323433646262313232616537663933353334323566383466336466636439356664636430663932313033376639653137313661313665666239636639373761363238393432613565653139336161323964333164393961366464626238306431643764643639623564613534616566666666666666663463366662656134363331313736643632303563393336626565323334353536346632626431396331656161376637366462383930646136386566663937613930303030303030303030666666666666666630326434313130313030303030303030303031393736613931346233346637636166666434303232346661306537313730323038373061656430633034623361396238386163356330313030303030303030303030303137613931343832383535343439313539396337393839313132626463363332623134613634633162356564346638373030303030303030227d"

	d, err := hex.DecodeString(wpi)
	assert.Nil(t, err)

	var m map[string]any
	err = json.Unmarshal(d, &m)
	assert.Nil(t, err)
	d, err = json.MarshalIndent(m, "", "\t")
	assert.Nil(t, err)
	t.Log(string(d))

	signedTxHex, rAllSigned, err := signer.UpdateMiddleSignedTxHex(wpi)
	assert.Nil(t, err)

	t.Log(rAllSigned)
	t.Log(signedTxHex)
}
